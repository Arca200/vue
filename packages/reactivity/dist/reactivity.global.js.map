{"version":3,"file":"reactivity.global.js","sources":["../../shared/src/index.js","../src/effect.js","../src/baseHandler.js","../src/reactive.js"],"sourcesContent":["function isObject (param) {\n  return Object.prototype.toString.call(param) === '[object Object]'\n}\n\nfunction isString (param) {\n  return Object.prototype.toString.call(param) === '[object String]'\n}\n\nfunction isBoolean (param) {\n  return Object.prototype.toString.call(param) === '[object Boolean]'\n}\n\nfunction isNull (param) {\n  return Object.prototype.toString.call(param) === '[object Null]'\n}\n\nfunction isUndefined (param) {\n  return Object.prototype.toString.call(param) === '[object Undefined]'\n}\n\nfunction isArray (param) {\n  return Object.prototype.toString.call(param) === '[object Array]'\n}\n\nfunction isFunction (param) {\n  return Object.prototype.toString.call(param) === '[object Function]'\n}\n\nfunction isDate (param) {\n  return Object.prototype.toString.call(param) === '[object Date]'\n}\n\nfunction isRegExp (param) {\n  return Object.prototype.toString.call(param) === '[object RegExp]'\n}\n\nfunction hasChanged (param1, param2) {\n  return param1 !== param2\n}\n\nfunction hasOwnProperty (obj, key) {\n  return Object.prototype.hasOwnProperty.call(obj, key)\n}\n\nexport {\n  isObject,\n  isArray,\n  isString,\n  isBoolean,\n  isDate,\n  isFunction,\n  isNull,\n  isUndefined,\n  isRegExp,\n  hasChanged,\n  hasOwnProperty,\n}\n// export {\n//   ShapeFlags\n// } from './flags'","class ReactiveEffect {\n  constructor (fn, scheduler = null) {\n    this._fn = fn\n    this.scheduler = scheduler\n    this.deps = new Set\n  }\n\n  run () {\n    activeEffect = this\n    return this._fn()\n  }\n\n  stop () {\n    cleanEffect(this)\n  }\n}\n\nfunction cleanEffect (effect) {\n  effect.deps.forEach(dep => dep.delete(effect))\n  effect.deps.clear()\n}\n\nlet activeEffect\nlet targetMap = new Map\n\nfunction effect (fn, options = null) {\n  let scheduler = (options && options.scheduler) ? options.scheduler : null\n  const _effect = new ReactiveEffect(fn, scheduler)\n  _effect.run()\n  const runner = _effect.run.bind(_effect)\n  runner.effect = _effect\n  // effect函数在执行完毕之后就将activeEffect设为null，这样在effect函数之外就不会收集依赖了\n  activeEffect = null\n  return runner\n}\n\nfunction track (target, key) {\n  // effect函数执行完毕之后就不应该收集依赖了，直接返回\n  if (!activeEffect) {\n    return\n  }\n  let depsMap = targetMap.get(target)\n  if (!depsMap) {\n    targetMap.set(target, (depsMap = new Map))\n  }\n\n  let deps = depsMap.get(key)\n  if (!deps) {\n    depsMap.set(key, (deps = new Set))\n  }\n  // 触发依赖的情况下收集依赖就会跳过收集，但是可能会创建新的proxy对象\n  if (!deps.has(activeEffect)) {\n    deps.add(activeEffect)\n    activeEffect.deps.add(deps)\n  }\n}\n\nfunction trigger (target, key) {\n  const deps = targetMap.get(target).get(key)\n  for (const effect of deps) {\n    if (effect.scheduler) {\n      effect.scheduler()\n    } else {\n      // 在此期间执行依赖的话，由于依赖已经添加在deps中了，所以会直接跳过\n      effect.run()\n    }\n  }\n  // 防止在effect之外收集依赖\n  activeEffect = null\n}\n\nfunction stop (runner) {\n  runner.effect.stop()\n}\n\nexport {\n  track, trigger, effect, stop\n}","import { track, trigger } from './effect.js'\nimport { isObject } from '../../shared/src/index.js'\nimport { reactive, readonly } from './reactive.js'\n\nfunction createGet (isReadOnly = false, isShallow = false) {\n  return (target, key) => {\n    if (key === 'isReactive') {\n      return !isReadOnly\n    } else if (key === 'isReadOnly') {\n      return isReadOnly\n    }\n    const res = Reflect.get(target, key)\n    if (!isReadOnly) {\n      track(target, key)\n    }\n    if (!isShallow && isObject(res)) {\n      return isReadOnly ? readonly(res) : reactive(res)\n    } else {\n      return res\n    }\n  }\n}\n\nfunction createSet (isReadOnly = false) {\n  return (target, key, val) => {\n    if (isReadOnly) {\n      console.error('只读响应式对象不可被赋值')\n    }\n    const res = Reflect.set(target, key, val)\n    //TODO 触发依赖\n    trigger(target, key)\n    return res\n  }\n\n}\n\nconst reactiveHandler = {\n  get: createGet(),\n  set: createSet()\n}\nconst shallowHandler = {\n  get: createGet(false, true),\n  set: createSet()\n}\nconst readOnlyHandler = {\n  get: createGet(true, false),\n  set: createSet(true)\n}\nconst shallowReadOnlyHandler = {\n  get: createGet(true, true),\n  set: createSet(true)\n}\nexport {\n  reactiveHandler,\n  shallowHandler,\n  readOnlyHandler,\n  shallowReadOnlyHandler\n}","import { isObject } from '../../shared/src'\nimport { reactiveHandler, readOnlyHandler, shallowHandler, shallowReadOnlyHandler } from './baseHandler.js'\n\nconst reactiveMap = new WeakMap()\nconst readOnlyMap = new WeakMap()\n\nfunction createReactiveObject (target, isReadOnly, handler) {\n  if (isObject(target) !== true) {\n    console.error('必须传入一个对象')\n  }\n  const proxyMap = isReadOnly ? readOnlyMap : reactiveMap\n  let proxy = proxyMap.get(target)\n  if (proxy) {\n    return proxy\n  } else {\n    proxy = new Proxy(target, handler)\n    proxyMap.set(target, proxy)\n    return proxy\n  }\n}\n\nfunction reactive (target) {\n  return createReactiveObject(target, false, reactiveHandler)\n}\n\nfunction readonly (target) {\n  return createReactiveObject(target, true, readOnlyHandler)\n}\n\nfunction shallowReactive (target) {\n  return createReactiveObject(target, false, shallowHandler)\n}\n\nfunction shallowReadonly (target) {\n  return createReactiveObject(target, true, shallowReadOnlyHandler)\n}\n\nfunction isReactive (target) {\n  return !!target['isReactive']\n}\n\nfunction isReadOnly (target) {\n  return !!target['isReadOnly']\n}\n\nfunction isProxy (target) {\n  return isReactive(target) || isReadOnly(target)\n}\n\nexport {\n  reactive,\n  readonly,\n  shallowReactive,\n  shallowReadonly,\n  isReactive,\n  isReadOnly,\n  isProxy\n}"],"names":[],"mappings":"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"}