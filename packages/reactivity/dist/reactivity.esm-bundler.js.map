{"version":3,"file":"reactivity.esm-bundler.js","sources":["../../shared/src/index.js","../src/effect.js","../src/baseHandler.js","../src/reactive.js"],"sourcesContent":["function isObject (param) {\n  return Object.prototype.toString.call(param) === '[object Object]'\n}\n\nfunction isString (param) {\n  return Object.prototype.toString.call(param) === '[object String]'\n}\n\nfunction isBoolean (param) {\n  return Object.prototype.toString.call(param) === '[object Boolean]'\n}\n\nfunction isNull (param) {\n  return Object.prototype.toString.call(param) === '[object Null]'\n}\n\nfunction isUndefined (param) {\n  return Object.prototype.toString.call(param) === '[object Undefined]'\n}\n\nfunction isArray (param) {\n  return Object.prototype.toString.call(param) === '[object Array]'\n}\n\nfunction isFunction (param) {\n  return Object.prototype.toString.call(param) === '[object Function]'\n}\n\nfunction isDate (param) {\n  return Object.prototype.toString.call(param) === '[object Date]'\n}\n\nfunction isRegExp (param) {\n  return Object.prototype.toString.call(param) === '[object RegExp]'\n}\n\nfunction hasChanged (param1, param2) {\n  return param1 !== param2\n}\n\nfunction hasOwnProperty (obj, key) {\n  return Object.prototype.hasOwnProperty.call(obj, key)\n}\n\nexport {\n  isObject,\n  isArray,\n  isString,\n  isBoolean,\n  isDate,\n  isFunction,\n  isNull,\n  isUndefined,\n  isRegExp,\n  hasChanged,\n  hasOwnProperty,\n}\n// export {\n//   ShapeFlags\n// } from './flags'","class ReactiveEffect {\n  constructor (fn, scheduler = null) {\n    this._fn = fn\n    this.scheduler = scheduler\n    this.deps = new Set\n  }\n\n  run () {\n    activeEffect = this\n    return this._fn()\n  }\n\n  stop () {\n    cleanEffect(this)\n  }\n}\n\nfunction cleanEffect (effect) {\n  effect.deps.forEach(dep => dep.delete(effect))\n  effect.deps.clear()\n}\n\nlet activeEffect\nlet targetMap = new Map\n\nfunction effect (fn, options = null) {\n  let scheduler = (options && options.scheduler) ? options.scheduler : null\n  const _effect = new ReactiveEffect(fn, scheduler)\n  _effect.run()\n  const runner = _effect.run.bind(_effect)\n  runner.effect = _effect\n  // effect函数在执行完毕之后就将activeEffect设为null，这样在effect函数之外就不会收集依赖了\n  activeEffect = null\n  return runner\n}\n\nfunction track (target, key) {\n  // effect函数执行完毕之后就不应该收集依赖了，直接返回\n  if (!activeEffect) {\n    return\n  }\n  let depsMap = targetMap.get(target)\n  if (!depsMap) {\n    targetMap.set(target, (depsMap = new Map))\n  }\n\n  let deps = depsMap.get(key)\n  if (!deps) {\n    depsMap.set(key, (deps = new Set))\n  }\n  // 触发依赖的情况下收集依赖就会跳过收集，但是可能会创建新的proxy对象\n  if (!deps.has(activeEffect)) {\n    deps.add(activeEffect)\n    activeEffect.deps.add(deps)\n  }\n}\n\nfunction trigger (target, key) {\n  const deps = targetMap.get(target).get(key)\n  for (const effect of deps) {\n    if (effect.scheduler) {\n      effect.scheduler()\n    } else {\n      // 在此期间执行依赖的话，由于依赖已经添加在deps中了，所以会直接跳过\n      effect.run()\n    }\n  }\n  // 防止在effect之外收集依赖\n  activeEffect = null\n}\n\nfunction stop (runner) {\n  runner.effect.stop()\n}\n\nexport {\n  track, trigger, effect, stop\n}","import { track, trigger } from './effect.js'\nimport { isObject } from '../../shared/src/index.js'\nimport { reactive, readonly } from './reactive.js'\n\nfunction createGet (isReadOnly = false, isShallow = false) {\n  return (target, key) => {\n    if (key === 'isReactive') {\n      return !isReadOnly\n    } else if (key === 'isReadOnly') {\n      return isReadOnly\n    }\n    const res = Reflect.get(target, key)\n    if (!isReadOnly) {\n      track(target, key)\n    }\n    if (!isShallow && isObject(res)) {\n      return isReadOnly ? readonly(res) : reactive(res)\n    } else {\n      return res\n    }\n  }\n}\n\nfunction createSet (isReadOnly = false) {\n  return (target, key, val) => {\n    if (isReadOnly) {\n      console.error('只读响应式对象不可被赋值')\n    }\n    const res = Reflect.set(target, key, val)\n    //TODO 触发依赖\n    trigger(target, key)\n    return res\n  }\n\n}\n\nconst reactiveHandler = {\n  get: createGet(),\n  set: createSet()\n}\nconst shallowHandler = {\n  get: createGet(false, true),\n  set: createSet()\n}\nconst readOnlyHandler = {\n  get: createGet(true, false),\n  set: createSet(true)\n}\nconst shallowReadOnlyHandler = {\n  get: createGet(true, true),\n  set: createSet(true)\n}\nexport {\n  reactiveHandler,\n  shallowHandler,\n  readOnlyHandler,\n  shallowReadOnlyHandler\n}","import { isObject } from '../../shared/src'\nimport { reactiveHandler, readOnlyHandler, shallowHandler, shallowReadOnlyHandler } from './baseHandler.js'\n\nconst reactiveMap = new WeakMap()\nconst readOnlyMap = new WeakMap()\n\nfunction createReactiveObject (target, isReadOnly, handler) {\n  if (isObject(target) !== true) {\n    console.error('必须传入一个对象')\n  }\n  const proxyMap = isReadOnly ? readOnlyMap : reactiveMap\n  let proxy = proxyMap.get(target)\n  if (proxy) {\n    return proxy\n  } else {\n    proxy = new Proxy(target, handler)\n    proxyMap.set(target, proxy)\n    return proxy\n  }\n}\n\nfunction reactive (target) {\n  return createReactiveObject(target, false, reactiveHandler)\n}\n\nfunction readonly (target) {\n  return createReactiveObject(target, true, readOnlyHandler)\n}\n\nfunction shallowReactive (target) {\n  return createReactiveObject(target, false, shallowHandler)\n}\n\nfunction shallowReadonly (target) {\n  return createReactiveObject(target, true, shallowReadOnlyHandler)\n}\n\nfunction isReactive (target) {\n  return !!target['isReactive']\n}\n\nfunction isReadOnly (target) {\n  return !!target['isReadOnly']\n}\n\nfunction isProxy (target) {\n  return isReactive(target) || isReadOnly(target)\n}\n\nexport {\n  reactive,\n  readonly,\n  shallowReactive,\n  shallowReadonly,\n  isReactive,\n  isReadOnly,\n  isProxy\n}"],"names":[],"mappings":"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"}